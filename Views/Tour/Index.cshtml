@model TravelWebsite.ViewModels.TourIndexViewModel
@{
    ViewData["Title"] = "Tour Du Lịch";
}

@section Styles {
    <link rel="stylesheet" href="~/css/tour.css" asp-append-version="true" />
}

<!-- Tour Banner -->
<div class="tour-banner text-white py-5">
    <div class="container py-4">
        <div class="row align-items-center">
            <div class="col-lg-7">
                <h1 class="tour-title display-4 fw-bold mb-3">Khám Phá Tour Du Lịch</h1>
                <p class="tour-subtitle lead mb-4">Trải nghiệm những chuyến đi tuyệt vời với các gói tour hấp dẫn, được thiết kế đặc biệt để tạo nên những kỷ niệm khó quên.</p>
                @if (User.IsInRole("Admin"))
                {
                    <a asp-action="Create" class="btn btn-light tour-button px-4 py-2">
                        <i class="bi bi-plus-circle me-2"></i> Thêm Tour Mới
                    </a>
                }
            </div>
            <div class="col-lg-5 d-none d-lg-block">
                <div class="position-relative" data-aos="fade-left">
                    <img src="@Url.Content("~/images/general/banner-tour.jpg")" alt="Tour Du Lịch" class="img-fluid rounded-3 shadow-lg" style="border: 5px solid rgba(255,255,255,0.2);">
                    <div class="position-absolute top-0 end-0 translate-middle-y p-3 bg-white rounded-circle shadow-lg" style="margin-right: -20px;">
                        <i class="bi bi-airplane-fill text-danger" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container py-5">
    <!-- Statistics -->
    <div class="tour-stats mb-5" data-aos="fade-up">
        <div class="tour-stat-card">
            <i class="bi bi-map"></i>
            <h3 class="stat-value counter-value" data-target="@Model.Tours.Count()">0</h3>
            <p class="stat-label">Tours Du Lịch</p>
        </div>
        <div class="tour-stat-card">
            <i class="bi bi-geo-alt"></i>
            <h3 class="stat-value counter-value" data-target="@Model.Tours.Select(t => t.Destination).Distinct().Count()">0</h3>
            <p class="stat-label">Điểm Đến</p>
        </div>
        <div class="tour-stat-card">
            <i class="bi bi-star"></i>
            <h3 class="stat-value counter-value" data-target="@Model.Tours.Count(t => t.IsPopular)">0</h3>
            <p class="stat-label">Tours Phổ Biến</p>
        </div>
        <div class="tour-stat-card">
            <i class="bi bi-people"></i>
            <h3 class="stat-value counter-value" data-target="1500">0</h3>
            <p class="stat-label">Khách Hàng Hài Lòng</p>
        </div>
    </div>

    <!-- Advanced Filter -->
    <div class="tour-filter-panel p-4" data-aos="fade-up">
        <h5 class="fw-bold mb-4"><i class="bi bi-funnel me-2"></i>Tìm kiếm tour du lịch</h5>
        <form method="get" id="filterForm" class="tour-search-form">
            <input type="hidden" name="page" id="currentPage" value="@Model.CurrentPage" />
            <input type="hidden" name="sortOrder" id="sortOrderInput" value="@Model.SortOrder" />
            <div class="row g-3">
                <div class="col-lg-4 col-md-6 filter-col">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" class="form-control" id="searchName" name="searchName" placeholder="Tên tour du lịch..." value="@Model.SearchName">
                    </div>
                </div>
                <div class="col-lg-2 col-md-6 filter-col">
                    <select class="form-select" id="destinationId" name="destinationId" onchange="document.getElementById('filterForm').submit()">
                        <option value="">Tất cả điểm đến</option>
                        @foreach (var destination in ViewBag.Destinations)
                        {
                            @if (Model.DestinationId == destination.Id)
                            {
                                <option value="@destination.Id" selected>@destination.Name</option>
                            }
                            else
                            {
                                <option value="@destination.Id">@destination.Name</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-lg-2 col-md-6 filter-col">
                    <select class="form-select" id="priceRange" onchange="updatePriceRange(this.value)">
                        <option value="">Tất cả giá</option>
                        @if (Model.MaxPrice == 1000000) 
                        {
                            <option value="0-1000000" selected>Dưới 1 triệu</option>
                        }
                        else
                        {
                            <option value="0-1000000">Dưới 1 triệu</option>
                        }

                        @if (Model.MinPrice == 1000000 && Model.MaxPrice == 3000000)
                        {
                            <option value="1000000-3000000" selected>1 - 3 triệu</option>
                        }
                        else
                        {
                            <option value="1000000-3000000">1 - 3 triệu</option>
                        }

                        @if (Model.MinPrice == 3000000 && Model.MaxPrice == 5000000)
                        {
                            <option value="3000000-5000000" selected>3 - 5 triệu</option>
                        }
                        else
                        {
                            <option value="3000000-5000000">3 - 5 triệu</option>
                        }

                        @if (Model.MinPrice == 5000000 && Model.MaxPrice == 10000000)
                        {
                            <option value="5000000-10000000" selected>5 - 10 triệu</option>
                        }
                        else
                        {
                            <option value="5000000-10000000">5 - 10 triệu</option>
                        }

                        @if (Model.MinPrice == 10000000)
                        {
                            <option value="10000000" selected>Trên 10 triệu</option>
                        }
                        else
                        {
                            <option value="10000000">Trên 10 triệu</option>
                        }
                    </select>
                    <input type="hidden" id="minPrice" name="minPrice" value="@Model.MinPrice" />
                    <input type="hidden" id="maxPrice" name="maxPrice" value="@Model.MaxPrice" />
                </div>
                <div class="col-lg-2 col-md-6 filter-col">
                    <select class="form-select" id="sortSelect" onchange="updateSort(this.value)">
                        @if (Model.SortOrder == "name_asc")
                        {
                            <option value="name_asc" selected>Tên (A-Z)</option>
                        }
                        else
                        {
                            <option value="name_asc">Tên (A-Z)</option>
                        }

                        @if (Model.SortOrder == "name_desc")
                        {
                            <option value="name_desc" selected>Tên (Z-A)</option>
                        }
                        else
                        {
                            <option value="name_desc">Tên (Z-A)</option>
                        }

                        @if (Model.SortOrder == "price_asc")
                        {
                            <option value="price_asc" selected>Giá (Thấp-Cao)</option>
                        }
                        else
                        {
                            <option value="price_asc">Giá (Thấp-Cao)</option>
                        }

                        @if (Model.SortOrder == "price_desc")
                        {
                            <option value="price_desc" selected>Giá (Cao-Thấp)</option>
                        }
                        else
                        {
                            <option value="price_desc">Giá (Cao-Thấp)</option>
                        }

                        @if (Model.SortOrder == "duration_asc")
                        {
                            <option value="duration_asc" selected>Thời gian (Ngắn-Dài)</option>
                        }
                        else
                        {
                            <option value="duration_asc">Thời gian (Ngắn-Dài)</option>
                        }

                        @if (Model.SortOrder == "duration_desc")
                        {
                            <option value="duration_desc" selected>Thời gian (Dài-Ngắn)</option>
                        }
                        else
                        {
                            <option value="duration_desc">Thời gian (Dài-Ngắn)</option>
                        }
                    </select>
                </div>
                <div class="col-lg-2 col-md-12 d-flex">
                    <button type="submit" class="btn btn-primary w-100 me-2">
                        <i class="bi bi-search me-2"></i>Tìm kiếm
                    </button>
                    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-repeat"></i>
                    </a>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-12">
                    <div class="form-check form-switch">
                        @if (Model.IsPopular == true)
                        {
                            <input class="form-check-input" type="checkbox" id="isPopular" name="isPopular" value="true" checked onchange="document.getElementById('filterForm').submit()">
                        }
                        else
                        {
                            <input class="form-check-input" type="checkbox" id="isPopular" name="isPopular" value="true" onchange="document.getElementById('filterForm').submit()">
                        }
                        <label class="form-check-label" for="isPopular">Chỉ hiện tour phổ biến</label>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Tours List -->
    <div class="tour-grid row g-4 mt-4">
        @if (Model.Tours.Any())
        {
            int i = 0;
            @foreach (var tour in Model.Tours)
            {
                <div class="col-lg-4 col-md-6 mb-4 tour-card-wrapper" 
                     data-name="@tour.Name" 
                     data-price="@tour.Price" 
                     data-duration="@tour.Duration" 
                     data-popular="@tour.IsPopular.ToString().ToLower()"
                     style="--animation-order:@(i++)">
                    <div class="card h-100 border-0 shadow-sm tour-card">
                        <div class="position-relative">
                            <img src="@(string.IsNullOrEmpty(tour.ImageUrl) ? Url.Content($"~/images/tours/tour-{(tour.Id % 6) + 1}.jpg") : tour.ImageUrl)" 
                                 onerror="this.onerror=null;this.src='@Url.Content($"~/images/tours/tour-{(tour.Id % 6) + 1}.jpg")'"
                                 class="card-img-top" alt="@tour.Name">
                            <div class="tour-card-overlay"></div>
                            <div class="tour-price">
                                <strong>@tour.Price.ToString("N0") VNĐ</strong>
                            </div>
                            @if (tour.IsPopular)
                            {
                                <div class="tour-popular">
                                    <i class="bi bi-star-fill"></i> Phổ biến
                                </div>
                                <div class="tour-featured">
                                    <i class="bi bi-bookmark-star-fill"></i>
                                </div>
                            }
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">@tour.Name</h5>
                            <div class="tour-info-item">
                                <div class="tour-info-icon">
                                    <i class="bi bi-geo-alt"></i>
                                </div>
                                <span>@tour.Destination.Name, @tour.Destination.Country</span>
                            </div>
                            <div class="tour-info-item">
                                <div class="tour-info-icon">
                                    <i class="bi bi-clock"></i>
                                </div>
                                <span>@(tour.Duration.HasValue ? $"{tour.Duration} ngày" : "Liên hệ để biết thêm chi tiết")</span>
                            </div>
                            <div class="tour-info-item">
                                <div class="tour-info-icon">
                                    <i class="bi bi-calendar-check"></i>
                                </div>
                                <span>Khởi hành hàng ngày</span>
                            </div>
                            <p class="card-text mt-3">@(string.IsNullOrEmpty(tour.Description) 
                                ? "Khám phá tour du lịch tuyệt vời này cùng chúng tôi." 
                                : (tour.Description.Length > 100 ? tour.Description.Substring(0, 100) + "..." : tour.Description))</p>
                        </div>
                        <div class="card-footer bg-white border-top-0 pt-0">
                            <a asp-action="Details" asp-route-id="@tour.Id" class="btn btn-outline-primary w-100">
                                Xem chi tiết <i class="bi bi-arrow-right ms-1"></i>
                            </a>
                            @if (User.IsInRole("Admin"))
                            {
                                <div class="d-flex justify-content-between mt-3 tour-admin-buttons">
                                    <a asp-action="Edit" asp-route-id="@tour.Id" class="btn btn-sm btn-outline-secondary w-50 me-1">
                                        <i class="bi bi-pencil me-1"></i> Sửa
                                    </a>
                                    <a asp-action="Delete" asp-route-id="@tour.Id" class="btn btn-sm btn-outline-danger w-50 ms-1">
                                        <i class="bi bi-trash me-1"></i> Xóa
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        }
    </div>
    
    <!-- Empty state -->
    @if (!Model.Tours.Any())
    {
        <div class="tour-empty-state">
            <i class="bi bi-ticket-perforated"></i>
            <h4>Không tìm thấy tour du lịch nào</h4>
            <p>Hiện tại không có tour du lịch nào phù hợp với tiêu chí tìm kiếm của bạn. Vui lòng thử lại với các bộ lọc khác.</p>
            @if (User.IsInRole("Admin"))
            {
                <a asp-action="Create" class="btn btn-primary mt-3">
                    <i class="bi bi-plus-circle me-2"></i> Thêm Tour Mới
                </a>
            }
            else
            {
                <button type="button" class="btn btn-primary mt-3 reset-filters">
                    <i class="bi bi-arrow-repeat me-2"></i> Đặt lại bộ lọc
                </button>
            }
        </div>
    }

    <!-- Pagination -->
    @if (Model.TotalPages > 1)
    {
        <nav aria-label="Page navigation" class="my-4">
            <ul class="pagination justify-content-center">
                <li class="page-item @(!Model.HasPreviousPage ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("Index", new { page = Model.CurrentPage - 1, searchName = Model.SearchName, minPrice = Model.MinPrice, maxPrice = Model.MaxPrice, destinationId = Model.DestinationId, isPopular = Model.IsPopular, sortOrder = Model.SortOrder })" 
                       tabindex="-1" aria-disabled="@(!Model.HasPreviousPage)">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
                
                @{
                    const int maxPagesToShow = 5;
                    int startPage = Math.Max(1, Model.CurrentPage - maxPagesToShow / 2);
                    int endPage = Math.Min(Model.TotalPages, startPage + maxPagesToShow - 1);
                    
                    if (endPage - startPage + 1 < maxPagesToShow)
                    {
                        startPage = Math.Max(1, endPage - maxPagesToShow + 1);
                    }
                    
                    // First page
                    if (startPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("Index", new { page = 1, searchName = Model.SearchName, minPrice = Model.MinPrice, maxPrice = Model.MaxPrice, destinationId = Model.DestinationId, isPopular = Model.IsPopular, sortOrder = Model.SortOrder })">1</a>
                        </li>
                        if (startPage > 2)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                    }
                    
                    // Page numbers
                    for (int p = startPage; p <= endPage; p++)
                    {
                        <li class="page-item @(p == Model.CurrentPage ? "active" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { page = p, searchName = Model.SearchName, minPrice = Model.MinPrice, maxPrice = Model.MaxPrice, destinationId = Model.DestinationId, isPopular = Model.IsPopular, sortOrder = Model.SortOrder })">@p</a>
                        </li>
                    }
                    
                    // Last page
                    if (endPage < Model.TotalPages)
                    {
                        if (endPage < Model.TotalPages - 1)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("Index", new { page = Model.TotalPages, searchName = Model.SearchName, minPrice = Model.MinPrice, maxPrice = Model.MaxPrice, destinationId = Model.DestinationId, isPopular = Model.IsPopular, sortOrder = Model.SortOrder })">@Model.TotalPages</a>
                        </li>
                    }
                }
                
                <li class="page-item @(!Model.HasNextPage ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("Index", new { page = Model.CurrentPage + 1, searchName = Model.SearchName, minPrice = Model.MinPrice, maxPrice = Model.MaxPrice, destinationId = Model.DestinationId, isPopular = Model.IsPopular, sortOrder = Model.SortOrder })">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    }
</div>

@section Scripts {
    <script src="~/js/tour.js" asp-append-version="true"></script>
    <script>
        function updateSort(value) {
            document.getElementById('sortOrderInput').value = value;
            document.getElementById('filterForm').submit();
        }
        
        function updatePriceRange(value) {
            if (value) {
                const [min, max] = value.split('-');
                document.getElementById('minPrice').value = min;
                document.getElementById('maxPrice').value = max || '';
            } else {
                document.getElementById('minPrice').value = '';
                document.getElementById('maxPrice').value = '';
            }
            document.getElementById('filterForm').submit();
        }
        
        function goToPage(page) {
            document.getElementById('currentPage').value = page;
            document.getElementById('filterForm').submit();
        }
    </script>
}